<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta http-equiv="x-ua-compatible" content="ie=edge"/>
    <title>devShare</title>
    <!-- MDB icon -->
    <link
            rel="icon"
            type="image/x-icon"
            href="../img/mdb-favicon.ico"
    />
    <!<!-- Font Awesome -->
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
            rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
            href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
            rel="stylesheet"
    />
    <!-- MDB -->
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.6.0/mdb.min.css"
            rel="stylesheet"
    />
</head>

<body>
<!-- Start your project here-->
<header>
    <nav class="navbar justify-content-center">
        <strong>
            <a class="navbar-brand" href="#">
                    <span style="color: #000000;margin-left: 10px;">
                        devShare
                    </span>
            </a>
        </strong>
    </nav>

    <div class="p-5 text-center bg-light">
        <button
                type="button"
                class="btn btn-primary"
                role="button"
                data-mdb-toggle="modal"
                data-mdb-target="#exampleModal"
        >파일 업로드 하기
        </button>

    </div>

    <!-- Modal -->
    <div
            class="modal fade"
            id="exampleModal"
            tabindex="-1"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true"
    >
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">파일 업로드</h5>
                    <button
                            type="button"
                            class="btn-close"
                            data-mdb-dismiss="modal"
                            aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <input id="file" type="file" class="form-control" name="files" required/>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">
                        Close
                    </button>
                    <button onclick="uploadFile()" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>

</header>

<main>
    <p> 파일 목록</p>
    {{#each Files}}
        <li>
            <a href="{{url}}">{{url}}</a>
        </li>
    {{/each}}
</main>

<script>
    async function uploadFile() {
        try {
            const preSignedUrl = await getPreSignedUrl();
            await uploadToS3With(preSignedUrl);
            await notifyUploaded(preSignedUrl);
            window.location.reload();
        } catch (error) {
            console.error(error);
        }
    }

    function notifyUploaded(preSignedUrl) {
        return fetch(`http://localhost:8080/file/save`, {
            method: 'POST',
            body: JSON.stringify({'fileUrl': preSignedUrl}),
            headers: {
                'Content-Type': "application/json"
            }
        })
                .then(response => response);
    }

    function getPreSignedUrl() {
        const file = getFile();

        return fetch(`http://localhost:8080/url/presigned?filename=${file.name}`)
                .then(response => response.json())
                .then(json => json.preSignedUrl)
    }

    function uploadToS3With(preSignedUrl) {
        const file = getFile();

        return fetch(preSignedUrl, {
            method: 'PUT',
            body: file,
            headers: {
                'Content-Type': 'multipart/form-data'
            }
        })
                .then(response => response)
    }

    function hasParams(preSignedUrl) {
        return preSignedUrl.indexOf("?") !== -1;
    }

    function slice(preSignedUrl) {
        return preSignedUrl.slice(0, preSignedUrl.indexOf("?"));
    }

    function getFile() {
        return document.getElementById("file").files[0];
    }

</script>

<!-- End your project here-->

<!-- MDB -->
<script
        type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.6.0/mdb.min.js"
></script>
</body>
</html>
